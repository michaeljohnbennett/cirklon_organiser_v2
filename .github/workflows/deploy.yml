name: Deploy Svelte App to GitHub Pages

on:
  push:
    branches:
      - main
      - master
      - feature/**

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Determine base path
        id: paths
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "base_path=/cirklon_organiser_v2/" >> $GITHUB_OUTPUT
            echo "dest_dir=" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "base_path=/cirklon_organiser_v2/$BRANCH_NAME/" >> $GITHUB_OUTPUT
            echo "dest_dir=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi
      
      - name: Build Svelte app
        run: |
          BASE_PATH="${{ steps.paths.outputs.base_path }}" npm run build
      
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
      
      - name: Deploy to gh-pages
        run: |
          cd gh-pages
          
          if [ -z "${{ steps.paths.outputs.dest_dir }}" ]; then
            # Deploy to root
            find . -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} +
            cp -r ../dist/* .
          else
            # Deploy to subdirectory
            DEST="${{ steps.paths.outputs.dest_dir }}"
            mkdir -p "$DEST"
            rm -rf "$DEST"/*
            cp -r ../dist/* "$DEST/"
          fi
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git diff --quiet --cached || git commit -m "Deploy from ${{ github.ref_name }}"
          git push

